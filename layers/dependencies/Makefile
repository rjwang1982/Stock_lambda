# Makefile for building Lambda Layer dependencies
# This ensures arm64 compatibility for AWS Lambda
#
# ä½œè€…: RJ.Wang
# é‚®ç®±: wangrenjun@gmail.com
# åˆ›å»ºæ—¶é—´: 2025-10-31
# ç‰ˆæœ¬: 1.0

.PHONY: build-layer clean verify help

# Default target
build-StockAnalysisLayer: build-layer

build-layer:
	@echo "ğŸš€ å¼€å§‹æ„å»º Lambda Layer (arm64)..."
	@echo "ğŸ“ æ¸…ç†æ—§çš„æ„å»ºäº§ç‰©..."
	rm -rf python/
	mkdir -p python/
	@echo "ğŸ³ ä½¿ç”¨ Docker æ„å»º arm64 ä¾èµ–åŒ…..."
	docker run --rm \
		--platform linux/arm64 \
		-v $(shell pwd):/workspace \
		-w /workspace \
		python:3.13-slim \
		bash -c " \
			echo 'ğŸ“¦ æ›´æ–°åŒ…ç®¡ç†å™¨...' && \
			apt-get update -qq && \
			apt-get install -y -qq gcc g++ && \
			echo 'ğŸ“¦ å®‰è£… Python ä¾èµ–åŒ…...' && \
			pip install --no-cache-dir --target python \
				pandas>=2.1.0 \
				akshare>=1.12.0 \
				numpy>=1.24.0 \
				requests>=2.31.0 && \
			echo 'ğŸ§¹ æ¸…ç†ä¸å¿…è¦æ–‡ä»¶...' && \
			find python -name '*.pyc' -delete && \
			find python -name '__pycache__' -type d -exec rm -rf {} + 2>/dev/null || true && \
			find python -name '*.dist-info' -type d -exec rm -rf {} + 2>/dev/null || true && \
			find python -name 'tests' -type d -exec rm -rf {} + 2>/dev/null || true && \
			echo 'ğŸ“Š è®¡ç®— Layer å¤§å°...' && \
			du -sh python/ \
		"
	@echo "âœ… Lambda Layer æ„å»ºå®Œæˆï¼"
	@echo "ğŸ“‹ éªŒè¯æ„å»ºç»“æœ..."
	@ls -la python/ | head -10
	@echo "ğŸ“ Layer å¤§å°: $$(du -sh python/ | cut -f1)"

clean:
	@echo "ğŸ§¹ æ¸…ç†æ„å»ºäº§ç‰©..."
	rm -rf python/
	@echo "âœ… æ¸…ç†å®Œæˆï¼"

# éªŒè¯ä¾èµ–åŒ…
verify:
	@echo "ğŸ” éªŒè¯ä¾èµ–åŒ…..."
	@python3 -c "import sys; sys.path.insert(0, 'python'); import pandas, akshare, numpy, requests; print('âœ… æ‰€æœ‰ä¾èµ–åŒ…éªŒè¯æˆåŠŸ')"

# æ˜¾ç¤ºå¸®åŠ©
help:
	@echo "å¯ç”¨å‘½ä»¤:"
	@echo "  build-layer  - æ„å»º Lambda Layer ä¾èµ–åŒ…"
	@echo "  clean        - æ¸…ç†æ„å»ºäº§ç‰©"
	@echo "  verify       - éªŒè¯ä¾èµ–åŒ…"
	@echo "  help         - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"